---
title: HAProxy之统计页面
date: 2025-12-26 08:00:00 +0800
categories: [高可用集群,HAProxy]
tags: [HAProxy-stats页面]
---
**统计页面介绍**

HAProxy的stats页面可以帮助我们：
- 实时查看前端/后端状态
- 查看后端节点是否UP / DOWN
- 当前连接数、QPS、响应时间
- 手动下线 / 上线节点(高级用法)

**实现方式**


**stats网页操作**

在haproxy节点上执行
```
vim /etc/haproxy/haproxy.cfg
```

在haproxy的配置文件里，在defaults后面或文件末尾新增以下内容：
```
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 5s
    stats realm HAProxy\ Statistics
    stats auth admin:admin888

```


说明：
- 8404是haproxy官方常用端口
- /stats是访问路径
- admin/admin888，默认认证信息，可自行配置


**重新加载haproxy配置**
```
haproxy -c -f /etc/haproxy/haproxy.cfg
```

配置有效会返回`Configuration file is valid`.


重新启动haproxy服务
```
systemctl restart haproxy
```

**访问统计页面**

浏览器访问haproxy的统计页面http://192.168.64.139:8404/stats,输入你配置的用户名和密码即可看到统计页面。如下图：

![](/assets/img/Pasted image 20251226065608.png)

或者命令行测试
```
curl -u admin:admin888 http://192.168.64.139:8404/stats
```


**统计页面应该怎么看**

FRONTED   前端监听状态
BACKEND   后端整体状态
web1/web2   单个节点状态
Status         UP / DOWN
Sessions       当前连接数
LastChk       最近健康检查

在前面我停掉了web1，web2的服务没有停，在上图可以看见web1的staus是DOWN，web2的status是UP。


**故障排查**

1、页面打不开

确认端口是否监听
```
ss -lntp | grep 8404
```

监听到会返回类似信息：`LISTEN 0      3000         0.0.0.0:8404      0.0.0.0:*    users:(("haproxy",pid=5840,fd=8))`。

2、firewalld未设置端口放行导致被拦截
```
firewall-cmd --add-port=8404/tcp --permanent
firewall-cmd --reload
```

3、curl验证显示401 Unauthorized

这是用户名或密码错误，并且curl命令一定要加上`-u`。

到这一步，我们就实现了stats统计页面的配置，实现后端节点的健康状态与连接数可视化监控，支持实施故障检测与服务状态观测。


**stats页面手动上下线节点**


本质是提供stats页面向HAProxy发送管理指令。

但是默认情况下HAproxy的配置是`stats enable`,只能看，不能操作。必须开启管理权限。

在原来的配置文件`/etc/haproxy/haproxy.cfg`
新加上这一行即可：
```
stats admin if TRUE
```

这行内容代表无条件允许管理操作(实验推荐)


--------------------------------------------------

**补充：**

我这里配置上下线节点用的是：
```
stats admin if TRUE
```

这个配置不够安全


一般使用如下配置：
```
stats admin if LOCALHOST
```

或者
```
stats admin if { src 127.0.0.1 }
```

```
stats admin if { src 192.168.100.0/24 }
```

**实验环境无条件开启，生产环境要基于IP控制管理权限。**

------------------------------------------------------------------------

检查并重启haproxy
```
haproxy -c -f /etc/haproxy/haproxy.cfg
systemctl restart haproxy
```

重新访问stats页面，登录

出现了可以操作的部分
![](/assets/img/Pasted image 20251226082832.png)

**图中的选项介绍**

**状态控制（最常用）**
- Set state to READY
- Set state to DRAIN
- Set state to MAINT

健康检查
- disable / enable checks
- force UP / DOWN / NOLB

很少用，一般用来故障测试。

Agent选项很少见，这里不提。

**Kill Sessions**
- 强制断开连接(危险操作,慎用！！！),会直接踢用户下线。



**平滑下线**

**操作**

需要把web1从负载均衡集群里摘出来

1、下线一个节点，在app里勾选web1下拉框选择set state to DRAIN然后点击Apply。

2、观察变化，web1的状态变成DRAIN，新的请求不会分发给web1，已有的连接会正常结束，这就是生产环境最标准的"平滑下线"。补充：这里我恢复了之前web1停止的nginx服务。

3、curl或者浏览器访问验证，只返回web2的内容。

**强制下线（故障应急）**

假设web1出现重大故障，需要立刻下线

**操作**

1、勾选web1，下拉框选择 Set state to MAINT，点击Apply。

2、web1变成MAINT状态，立刻不接受流量，state页面显示为维护状态。


MAINT和DRAIN的区别：

MAINT是立刻下线，DRAIN是平滑下线。

**重新上线节点(恢复服务)**

假设web1故障修复完成

**操作**

1、 勾选web1，下拉框选择Set state to READY。

2、web1状态变成UP，重新加入负载。


以上三种操作是比较常见的基本操作，其它先不管。


在HAProxy中可以通过stats页面进行后端节点的运维，日常发布使用DRAIN平滑下线，故障场景使用MAINT立刻摘除节点，服务恢复后通过READY重新加入负载。



到这一步，我们实现了：
- 配置HAProxy stats监控页面，支持后端节点状态可视化。
- 开启stats管理权限，实现后端服务节点的手动上下线。
- 掌握了HAProxy运维操作与应急故障处理流程。




