**HAProxy简介**

HAProxy是法国人Willy Tarreau开发的一款高性能TCP和HTTP负载均衡器。它是一个免费的软件，可以运行在大部分主流的Linux操作系统上。它提供了L4(TCP)和L7(HTTP)两种负载均衡能力。

我们使用HAProxy结合Linux搭建一个负载均衡集群。

**目的：** 使用HAProxy作为负载均衡器(Load Balancer)，将对web站点的请求分发到后端多台web节点(nginx或者httpd)，并对出现故障节点进行剔除。

环境：三台alma linux9虚拟机

**计划：**

一台作为负载均衡器，两台作为后端节点

| 角色  | 主机名     | IP             | 说明   |
| --- | ------- | -------------- | ---- |
| LB  | haproxy | 192.168.64.139 | 负载均衡 |
| web | web1    | 192.168.64.136 | 后端节点 |
| web | web2    | 192.168.64.134 | 后端节点 |


**部署步骤**

1、基础系统准备

所有机子关闭防火墙或者放行端口，禁用selinux

```
#  关闭并禁用防火墙
systemctl stop firewalld
systemctl disable firewalld

#  临时禁用selinux
setenforce 0
#  永久禁用selinux
sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config
```

2、部署后端web服务

web1和web2执行
```
dnf install -y nginx
systemctl enable --now nginx

```

修改首页内容，方便区别

web1
```
echo "This is Web1" > /usr/share/nginx/html/index.html
```

web2
```
echo "This is Web2" > /usr/share/nginx/html/index.html

```

先访问各自ip测试

3、HAProxy配置

在haproxy执行
```
dnf install -y haproxy
```

检查安装是否成功
```
haproxy -v
```

编辑配置文件
```
vim /etc/haproxy/haproxy.cfg
```

**默认的配置文件内容（添加注释版）**
```
#---------------------------------------------------------------------
# Example configuration for a possible web application.  See the
# full configuration options online.
#
#   https://www.haproxy.org/download/1.8/doc/configuration.txt
#
#---------------------------------------------------------------------

#---------------------------------------------------------------------
# Global settings   全局配置，作用于整个HAProxy进程
#---------------------------------------------------------------------
global
    # to have these messages end up in /var/log/haproxy.log you will
    # need to:
    #
    # 1) configure syslog to accept network log events.  This is done
    #    by adding the '-r' option to the SYSLOGD_OPTIONS in
    #    /etc/sysconfig/syslog
    #
    # 2) configure local2 events to go to the /var/log/haproxy.log
    #   file. A line like the following can be added to
    #   /etc/sysconfig/syslog
    #
    #    local2.*                       /var/log/haproxy.log
    #
    # 日志配置：
    # 将HAProxy日志发送到本地syslog（127.0.0.1），并标记为local2级别
    # 使用local2 这个 facility
    # 注意：需要在系统的rsyslog/syslog中额外配置才能真正写入文件
    log         127.0.0.1 local2
	
	# chroot目录，将HAProxy运行在该目录下，防止进程访问系统其它的目录，提升安全性
    chroot      /var/lib/haproxy
    # HAProxy进程PID文件路径
    pidfile     /var/run/haproxy.pid
    # 全局最大并发连接数，超过后新连接将被拒绝
    maxconn     4000
    # 指定运行HAProxy的系统用户和用户组，避免使用root，提升安全性
    user        haproxy
    group       haproxy
    # 以守护进程(后台)方式运行
    daemon
	
	# 启用统计信息的unix socket
	# 可用于：haproxy-admin、脚本监控、运维自动化
    # turn on stats unix socket
    stats socket /var/lib/haproxy/stats
	
	# 使用系统统一的SSL加密策略
	# alma / rhel系默认由 crypto-policies 管理
    # utilize system-wide crypto-policies
    ssl-default-bind-ciphers PROFILE=SYSTEM
    ssl-default-server-ciphers PROFILE=SYSTEM

#---------------------------------------------------------------------
# common defaults that all the 'listen' and 'backend' sections will
# use if not designated in their block
# defaults 默认配置
# 作用范围：所有 fronted / backend / listen，如果自身未定义，则继承这里的配置
#---------------------------------------------------------------------
defaults
	# 工作模式http，web应用通常使用这个
    mode                    http
    # 使用 global 中定义的日志配置
    log                     global
    # 记录http访问日志（包含请求方法、URL、状态码等）
    option                  httplog
    # 不记录空连接，例如客户端直接断开
    option                  dontlognull
    # 每次请求后主动关闭到后端的连接
    # 减少后端连接占用，适合短连接http服务
    option http-server-close
    # 除本地回环地址外，将客户端真实IP转发给后端
    option forwardfor       except 127.0.0.0/8
    # 后端服务器宕机时，允许重新分发请求到其它服务器
    option                  redispatch
    # 连接失败重试次数
    retries                 3
    # http请求头接收超时时间
    timeout http-request    10s
    # 请求在队列中等待的最长时间
    timeout queue           1m
    # 与后端服务器建立TCP连接的超时时间
    timeout connect         10s
    # 客户端空闲超时时间
    timeout client          1m
    # 后端服务器响应超时时间
    timeout server          1m
    # http keep-alive 空闲超时时间
    timeout http-keep-alive 10s
    # 健康检查超时时间
    timeout check           10s
    # 单个 fronted / backend 最大并发连接数
    maxconn                 3000

#---------------------------------------------------------------------
# main frontend which proxys to the backends
# fronted 前端
# 负责：接受用户请求，并将请求根据不同的规则分发到不同的backend
#---------------------------------------------------------------------
frontend main
	# 监听所有IP的5000端口
    bind *:5000
    
    # 定义ACL（访问控制规则）
    # 如果URL以以下目录开头，就匹配
    acl url_static       path_beg       -i /static /images /javascript /stylesheets
    # 如果URL以以下后缀结尾，就匹配
    acl url_static       path_end       -i .jpg .gif .png .css .js

	# 如果匹配到静态资源请求，则转发到static后端
    use_backend static          if url_static
    
    # 其它请求默认转发到 app 后端
    default_backend             app

#---------------------------------------------------------------------
# static backend for serving up images, stylesheets and such
# backend static(静态资源后端)
#---------------------------------------------------------------------
backend static
    # 负载均衡算法： 轮询
    balance     roundrobin
    # 静态资源服务器
    # check 代表开启健康检查
    server      static 127.0.0.1:4331 check

#---------------------------------------------------------------------
# round robin balancing between the various backends
# backendapp(后端应用实例)
# 轮询分发到各个应用实例
#---------------------------------------------------------------------
backend app
	# 轮询负载均衡
    balance     roundrobin
    # 定义多个后端应用服务器
    # check 代表启用健康检查，宕机会自动剔除
    server  app1 127.0.0.1:5001 check
    server  app2 127.0.0.1:5002 check
    server  app3 127.0.0.1:5003 check
    server  app4 127.0.0.1:5004 check
```


一般只需要配置fronted、backend以及listen的部分。


**修改的配置文件内容**

这里使用最简单的配置，只需要修改前端和后端部分即可
```
frontend main
    bind *:80
    acl url_static       path_beg       -i /static /images /javascript /stylesheets
    acl url_static       path_end       -i .jpg .gif .png .css .js

    use_backend static          if url_static
    default_backend             app


backend static
    balance     roundrobin
    server      static 127.0.0.1:4331 check


backend app
    balance     roundrobin
    server  web1 192.168.64.136:80 check
    server  web2 192.168.64.134:80 check
```

然后保存并提出

启动haproxy
```
systemctl enable --now haproxy
```

**负载均衡测试**

验证haproxy负载均衡配置是否成功
```
curl http://192.168.64.139
```
对LB多次执行这条命令

得到以下返回结果代表成功
```
[root@localhost ~]# curl http://192.168.64.139
This is Web2
[root@localhost ~]# curl http://192.168.64.139
This is Web1
[root@localhost ~]# curl http://192.168.64.139
This is Web2
[root@localhost ~]# curl http://192.168.64.139
This is Web1
[root@localhost ~]# curl http://192.168.64.139
This is Web2
```

也可以打开浏览器访问LB所在的IP地址，反复刷新，会显示不同的网页代表成功


**故障测试（重要）**

随便选一台web服务器，中断它的服务，模拟出现故障

这里选择web1执行
```
systemctl stop nginx
```

再次使用curl命令或者浏览器访问的方法测试

**输出结果：**
```
[root@localhost ~]# curl http://192.168.64.139
This is Web2
[root@localhost ~]# curl http://192.168.64.139
This is Web2
[root@localhost ~]# curl http://192.168.64.139
This is Web2
[root@localhost ~]# curl http://192.168.64.139
This is Web2
[root@localhost ~]# curl http://192.168.64.139
This is Web2
[root@localhost ~]# curl http://192.168.64.139
This is Web2
[root@localhost ~]# curl http://192.168.64.139
This is Web2
[root@localhost ~]# curl http://192.168.64.139
This is Web2
```

不会访问到web1，网页自动切换到web2

代表haproxy的健康检查生效



到了这一步已经做到了：
1. 使用HAProxy部署http负载均衡集群
2. 实现后端节点自动检查与故障自动摘除
3. 掌握轮询调度策略与服务验证的流程




