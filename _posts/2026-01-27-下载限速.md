**一、限速介绍**

限流（rate limiting）是Nginx众多特性中最有用的，也是经常容易错误配置的，特性之一的访问请求限速。此特性可以限制某个用户在一段时间内能够产生的http请求数。请求可以简单到就是一个对网页的get请求或者一个登录表格的post请求。用于安全目的上，比如减慢暴力破解密码攻击。通过限制进来的请求速率，结合日志标记目标URL来帮助防范DDoS攻击。一般来说，限流的作用是保护应用服务器不在同一时刻被大量的用户请求淹没。

限速方法：
- 下载速度限制
- 单位时间内请求次数限制
- 基于客户端的并发连接限速

Nginx限速模块：

|类型|模块|功能|
|---|---|---|
|下载/传输限速|核心模块|`limit_rate`、`limit_rate_after`|
|请求频率限速|ngx_http_limit_req_module|`limit_req_zone`、`limit_req`|
|并发连接数限制|ngx_http_limit_conn_module|`limit_conn_zone`、`limit_conn`|


**二、应用场景**

下载限速：限制下载速度和并发连接数，应用于下载服务器中，保护带宽和服务器的IO资源。

请求限速：限制单位时间内用户访问请求，防止恶意攻击，保护服务器及资源安全。

**三、限速原理**

**下载 / 传输限速原理：**Nginx将响应数据分成小块（chunk）发送，每发送一块后，计算是否超过限制速度，如果超过，延迟发送下一块，保持平均速度在limit_rate之内，limit_rate_after可以让前面指定的字节数不限速，再开始限速。

比如limit_rate 200k，每次发送16kb数据，Nginx会计算：
每秒允许发送200kb，每16kb块发送间隔=16kb / 200kb/s = 0.08秒。每发送一块16kb，就暂停约0.08秒，再继续发送。



**请求频率限制原理：**基于漏桶算法(leaky bucket)来实现限速。每个客户端IP分配一个桶，桶里放请求的令牌，控制请求速率。工作流程为：Nginx为每个IP在共享内存里记录请求时间，当请求到达以后，如果当前请求速率小于或等于设定的rate，就允许通过，否则就拒绝或延迟(取决于burst / nodelay)，burst参数允许突发请求。、

比如rate=5r/s，burst=10：每秒允许5个请求，短时间可以缓存10个请求，超过15个请求就会被拒绝。



**并发连接限制原理：**核心是计数器 + 共享内存：每个IP有一个计数器，每当新连接到达：计数器小于限制，允许建立连接，大于或等于限制，就拒绝连接返回503，连接关闭后，计数器减1。类似打牌，牌数满了就不能再发了。



**四、限速实现**

4.1、单位时间内请求数限制

基于IP对下载速率做限制，限制每秒处理1次请求，对突发超过5个以后的请求放入缓存区。

```
# nginx.conf
worker_processes  auto;  

events {
    worker_connections  1024;
}

http {
    # ----------------------------
    # 定义限速区域 limit_req_zone
    # ----------------------------
    # $binary_remote_addr ：使用客户端 IP 作为 key做标识来做限制
    # zone=haha:10m ：创建一个名为 'haha' 的共享内存区 10MB，用于存储IP访问频次状态信息
    # rate=1r/s ：每个IP每秒允许1个请求，这里选择限制每秒1次，也可以配置成30r/m
    limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;

    server {
        listen 80;
        server_name localhost;

        root /var/www/html;

        # ----------------------------
        # 应用限速规则 limit_req
        # ----------------------------
        location /downloads/ {
            # 使用上面定义的限速区域 'haha'
            # burst=5 ：允许短时间突发最多 5 个请求进入缓存区
            # nodelay ：不使用延迟模式，超出 burst 的请求立即返回 503
            # 如果不加 nodelay，则超出 burst 的请求会延迟处理
            limit_req zone=haha burst=5 nodelay;

            # 文件目录
            index index.html;

            # 可选：限速下载速度（每个请求发送数据速度）
            # limit_rate 200k;  # 每个请求每秒最多 200KB
        }

        # 可选：其他普通请求不限制
        location / {
            index index.html;
        }
    }
}

```

4.2、限制并发连接数

基于IP做连接限制，同一IP限制并发连接为1。

```
# nginx.conf
worker_processes  auto;

events {
    worker_connections 1024;
}

http {

    # ----------------------------------
    # 定义连接限制区域
    # ----------------------------------
    # $binary_remote_addr：
    #   客户端 IP（二进制格式，省内存）
    #
    # zone=conn_limit:10m：
    #   创建一个名为 conn_limit 的共享内存区，大小 10MB
    #   用于存储每个 IP 当前的并发连接数
    #
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    server {
        listen 80;
        server_name localhost;

        root /var/www/html;

        # ----------------------------------
        # 在指定 location 启用并发连接限制
        # ----------------------------------
        location /downloads/ {

            # limit_conn：
            #   conn_limit ：使用上面定义的 zone
            #   1          ：同一 IP 最多允许 1 个并发连接
            #
            limit_conn conn_limit 1;

            index index.html;
        }

        # 普通页面不限制
        location / {
            index index.html;
        }
    }
}

```


4.3、限制下载速度

下载速度为100kb/s

```
# nginx.conf
worker_processes  auto;

events {
    worker_connections 1024;
}

http {

    server {
        listen 80;
        server_name localhost;

        root /var/www/html;

        # ----------------------------------
        # 下载限速配置
        # ----------------------------------
        location /downloads/ {

            # limit_rate：
            #   限制每个连接的下载速度
            #   100k = 100KB/s
            #
            limit_rate 100k;

            # 可选：
            # limit_rate_after 0;
            # 表示从第 1 个字节开始就限速（默认行为）

            index index.html;
        }

        # 其他普通页面不做下载限速
        location / {
            index index.html;
        }
    }
}

```

4.4、综合案例

限制web服务器请求处理为1秒一个，触发值为5；

限制并发连接数为4;

限制下载速度为100.kb/s

```
# nginx.conf
worker_processes  auto;

events {
    worker_connections 1024;
}

http {

    # =========================================================
    # 请求频率限制（1 秒 1 次，突发 5）
    # =========================================================
    # 基于客户端 IP 进行限速
    # 使用 binary 格式 IP，节省内存
    #
    # rate=1r/s：
    #   每个 IP 每秒最多处理 1 个请求
    #
    limit_req_zone $binary_remote_addr zone=req_limit:10m rate=1r/s;

    # =========================================================
    # 并发连接数限制（每 IP 最多 4 个连接）
    # =========================================================
    # 为每个 IP 维护一个并发连接计数器
    #
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    server {
        listen 80;
        server_name localhost;

        root /var/www/html;

        # =====================================================
        # 综合限速应用区域
        # =====================================================
        location /downloads/ {

            # -----------------------------
            # 请求频率限制
            # -----------------------------
            # zone=req_limit ：使用请求限速区
            # burst=5        ：允许 5 个突发请求进入缓存队列
            # nodelay        ：超过 burst 的请求立即拒绝（503）
            #
            limit_req zone=req_limit burst=5 nodelay;

            # -----------------------------
            # 并发连接数限制
            # -----------------------------
            # conn_limit ：连接统计区
            # 4          ：同一 IP 最多 4 个并发连接
            #
            limit_conn conn_limit 4;

            # -----------------------------
            # 下载速度限制
            # -----------------------------
            # 每个连接最大下载速度 100KB/s
            #
            limit_rate 100k;

            index index.html;
        }

        # 其他普通页面不受限
        location / {
            index index.html;
        }
    }
}
```

总结

limit_req控制频率，limit_conn控制连接数量，limit_rate控制速度。


