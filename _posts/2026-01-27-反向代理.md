---
title: 反向代理
date: 2026-01-27 22:00:00 +0800
categories: [web服务器,nginx]
tags: [load balancing]
---
**介绍**

代理服务器扮演的是一个中间人的角色，代理分为正向代理和反向代理。

正向代理：代理的是客户端，帮助客户端访问外面的世界，比如科学上网、burp抓包、内网访问外网，服务器不知道真实的客户端是谁。

反向代理：代理的是服务器，对客户端来说，它就是服务器本身，常用于Nginx负载均衡、隐藏真实后端服务器，客户端只看见代理服务器。

Nginx的反向代理常用于负载均衡。

负载均衡（load balancing）就是把客户端的请求分配到多个服务器上，让每台服务器的压力均衡，保证系统性能和可用性。


**反向代理指令proxy_pass**
```
location / {
	root  html;
	index index.php index.html index.htm; #定义首页索引文件的名称
	proxy_pass http://mysvr ; #请求转向mysvr 定义的服务器列表
}
```


**七层负载均衡**

工作在应用层，支持HTTP / HTTPS协议，适合web应用
```
http {
	# upstream定义多个后端服务器
    upstream web {
        # 设置权重负载均衡策略，默认是轮询
        server 192.168.1.10 weight=5;
        server 192.168.1.11;
    }

    server {
        listen 80;
        server_name localhost;

        location / {
            proxy_pass http://web;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}

```

访问http://web,会由web池中的任意一个web服务器处理请求。

Nginx的其他负载均衡配置策略需要的时候再查就行，这里不多做拓展。


**四层负载均衡**

工作在传输层，支持非http协议（SSH、MySQL、Redis等），处理IP + 端口，转发速度快。

示例
```
stream {
    upstream sshers {
        server 192.168.1.129:22;  # SSH
        server 192.168.1.130:22;  # SSH
    }

    server {
        listen 192.168.1.130:2222;
        proxy_pass sshers;
    }
}
```

使用bitvise或者其他终端连接工具，连接192.168.1.130的2222端口，在终端会打开sshers里两台机子中的任意一个。


**反向代理优化**

| 参数                            | 作用说明                          | 示例/备注                                             |
| ----------------------------- | ----------------------------- | ------------------------------------------------- |
| `proxy_pass`                  | 指定后端服务器地址                     | `proxy_pass http://backend;`                      |
| `proxy_set_header`            | 设置转发请求的头部，保留客户端信息             | 常用：`Host`、`X-Real-IP`、`X-Forwarded-For`           |
| `proxy_redirect`              | 控制后端返回的 Location/Refresh 头部重写 | `proxy_redirect off;` 防止后端重定向到内部地址                |
| `proxy_http_version`          | 指定与后端的 HTTP 版本                | `proxy_http_version 1.1;` 配合长连接使用                 |
| `proxy_buffering`             | 是否启用代理缓存                      | `proxy_buffering on;` 可提高吞吐量，`off` 实时响应           |
| `proxy_buffers`               | 设置代理缓存缓冲区大小和数量                | `proxy_buffers 4 16k;` 影响大文件/响应性能                 |
| `proxy_busy_buffers_size`     | 当响应很大时的缓冲区上限                  | `proxy_busy_buffers_size 32k;` 配合 `proxy_buffers` |
| `proxy_connect_timeout`       | 连接后端服务器超时时间                   | 默认 60s，可根据后端性能调节                                  |
| `proxy_read_timeout`          | 读取后端响应超时时间                    | 防止慢响应阻塞连接，默认 60s                                  |
| `proxy_send_timeout`          | 发送请求到后端的超时时间                  | 防止请求发送卡住                                          |
| `proxy_cache`                 | 配置代理缓存，提高静态/重复请求性能            | 结合 `proxy_cache_path` 使用                          |
| `proxy_cache_valid`           | 设置缓存有效期                       | `proxy_cache_valid 200 10m;` 缓存 10 分钟             |
| `proxy_pass_request_headers`  | 是否传递客户端请求头到后端                 | 默认 on，必要时可以关闭                                     |
| `proxy_set_header Connection` | 设置连接类型，防止 HTTP 1.1 长连接问题      | `proxy_set_header Connection "";`                 |
| `proxy_max_temp_file_size`    | 缓存临时文件最大值                     | 防止大文件占满磁盘                                         |
| `proxy_temp_file_write_size`  | 每次写临时文件的大小                    | 优化磁盘写入效率                                          |
| `keepalive_timeout`           | 与客户端或后端保持连接的超时时间              | 减少 TCP 连接频繁建立的开销                                  |
| `keepalive_requests`          | 单个 keepalive 连接允许的最大请求数       | 减少连接重建开销                                          |


