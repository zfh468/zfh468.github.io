tomcat的优化可以提高网站的并发能力，tomcat在Java项目的使用率非常高。

一般tomcat的优化重要从自身配置以及tomcat所运行的jvm虚拟机的优化。优化的工作可以从安装好tomcat就开始。

tomcat9配置参考
https://tomcat.apache.org/tomcat-9.0-doc/config/

**一、AJP优化**

之前的内容提过AJP协议，但是生产环境一般使用Nginx + tomcat的架构，所以大多数时候用不到AJP协议，所以可以禁用它，在server.xml中它也是默认禁用的。


**二、运行模式优化(协议层面)**

tomcat的运行模式有3种：

1、bio

性能非常低下，没有经过任何优化处理和支持，适用于连接数目比较小且固定的架构，这种方式对服务器资源要求比较高，并发局限于应用中，jdk1.4以前唯一的选择，但程序简单容易理解。

2、nio(默认)

nio(new I/O)，是Java SE1.4及后续版本提供的一种新的I/O操作方式，相对传统的I/O操作方式(bio)拥有更好的并发运行性能。适用于连接数多且比较短的架构，比如聊天服务器，并发局限于应用中，编程比较复杂。AIO(NIO2)适用于连接数多且连接比较长的架构，比如相册服务器，充分调用OS参与并发操作，编程比较复杂，jdk7开始支持。

tomcat9默认使用nio运行模式。


3、apr

安装起来最困难，但是从操作系统级别来解决异步的I/O问题，大幅度的提高性能

进入tomcat的服务器状态页面查看默认的模式

apr运行模式

APR（Apache可移植运行库）的目的和名字一样，主要为上层的应用程序提供一个可以跨多操作系统平台的底层支持接口库。可以大大地提高tomcat对静态文件的处理性能。也是在tomcat上运行高并发应用的首选模式。

源码包安装

apr主程序与相关软件包下载地址
https://apr.apache.org/download.cgi

https://tomcat.apache.org/download-native.cgi


apr-1.7.6.tar.gz ：apr主程序包，包含了通用开发组件
apr-iconv-1.2.2.tar.gz ：用于实现iconv编码
apr-util-1.6.3.tar.gz ： 额外的开发组件
tomcat-native-2.0.12-src.tar.gz ： 关联tomcat和apr的组件



**部署apr环境**

1、环境准备

```
dnf groupinstall "Development Tools" -y
dnf install openssl-devel expat-devel -y
```

2、安装apr主程序包

所有软件包统一安装到`/usr/local/apr`

2.1、安装apr主程序包

```
# 解压
tar xf apr-1.7.6.tar.gz 
cd apr-1.7.6
# 配置
./configure --prefix=/usr/local/apr
# 编译并安装
make && make install
# 安装验证，输出版本好就OK
/usr/local/apr/bin/apr-1-config --version
```


2.2、安装apr-iconv

```
tar xf apr-iconv-1.2.2.tar.gz 
cd apr-iconv-1.2.2
./configure  --with-apr=/usr/local/apr --prefix=/usr
/local/apr-iconv
make  && make install
```

2.3、安装apr-util

```
tar xf apr-util-1.6.3.tar.gz 
cd apr-util-1.6.3
./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr --with-apr-iconv=/usr/local/apr-iconv/bin/apriconv
make  && make install
```

2.4、安装tomcat-native
```
tar xf tomcat-native-2.0.12-src.tar.gz 
cd tomcat-native-2.0.12-src/native/
./configure --with-apr=/usr/local/apr --prefix=/usr/local/apr --with-java-home=/usr/lib/jvm/jdk-11.0.29-oracle-x64
make  && make install
# 确认生成的库
ls /usr/local/apr/lib | grep tcnative
```

直接找java安装目录命令
```
ls /usr/lib/jvm/
```


2.5、native lib添加到系统库并刷新
```
echo "/usr/local/apr/lib" > /etc/ld.so.conf.d/apr.conf
ldconfig
```

验证：
```
ldconfig -p | grep tcnative
```

2.6、设置环境变量
```
vim /opt/tomcat1/bin/setenv.sh
```

内容：
```
#!/bin/bash

APR_HOME=/usr/local/apr

export LD_LIBRARY_PATH=$APR_HOME/lib:$LD_LIBRARY_PATH
export JAVA_OPTS="-Djava.library.path=$APR_HOME/lib $JAVA_OPTS"
```

给予执行权限即可，不需要手动执行
```
chmod +x /opt/tomcat1/bin/setenv.sh
```

2.7、修改server.xml
```
vim /opt/tomcat1/conf/server.xml
```

把tomcat切换到APR协议
```
<Connector
    port="8080"
    protocol="org.apache.coyote.http11.Http11AprProtocol"
    maxThreads="200"
    connectionTimeout="20000"
/>
```

2.8、重启tomcat并测试apr是否生效

重启tomcat
```
sh /opt/tomcat1/bin/shutdown.sh
sh /opt/tomcat1/bin/startup.sh
```



然后看日志：
```
grep -i apr /opt/tomcat1/logs/catalina.out
```

![[Pasted image 20260204235534.png]]

apr协议成功生效


**server.xml其它优化参数**

官方文档
https://tomcat.apache.org/tomcat-9.0-doc/config/http.html

maxThreads：最大线程数，默认200。增大值避免队列请求过多，导致响应缓慢。 minSpareThreads：最小空闲线程数。 
acceptCount：当处理请求超过此值时，将后来请求放到队列中等待。 
disableUploadTimeout：禁用上传超时时间 
connectionTimeout：连接超时，单位毫秒，0代表不限制 
URIEncoding：URI地址编码使用UTF-8 
enableLookups：关闭dns解析，提高响应时间 
compression：启用压缩功能 
compressionMinSize：最小压缩大小，单位Byte 
compressibleMimeType ：压缩的文件类型