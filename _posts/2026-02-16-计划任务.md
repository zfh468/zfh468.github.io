---
title: 计划任务
date: 2026-02-16 13:00:00 +0800
categories: [Linux,系统管理]
tags: [Scheduled Tasks]
---
计划任务可以帮助我们定期执行并完成设定的任务。常用于日志切割、日志分析、临时文件清理等。locate命令查询文件也需要通过计划任务定期执行updatedb命令更新数据库来实现。

计划任务不会在终端打印结果。如果想保存错误信息：`>> /tmp/task.log 2>&1`。

**1、at：一次性计划任务**

at类似一次性闹钟，定个时间执行一次，任务完成自动销毁。

安装at并启用atd服务

at常用管理命令：
```
# at + 时间
# 回车后进入交互界面，输入命令，Ctrl + D保存退出
at 14:30

# 10分钟后执行
at now + 10 minutes

# 查看当前的计划任务列表
atq

# 删除任务
atrm [任务号]
```

atd服务通过`/etc/at.allow`和`/etc/at.deny`管理哪些用户可用


**batch使用**

batch是at的一个辅助工具，它的核心逻辑是：不在固定时间执行，而是在系统空闲时执行。

batch只有在系统的平均负载降到0.8以下或你自定义的阈值时，才会开始执行任务。

batch使用方法与at类似，但不需要输入时间参数


交互式使用方法
```
batch
# 然后输入你要执行的任务或命令
# Ctrl + D 提交退出
```


管理命令与at通用，因为batch本质是把任务放入了at队列中，所以管理命令是一样的：
```
# 查看队列
atq

# 删除任务
atrm [任务号]
```

如果要自定义阈值，修改`/etc/sysconfig/atd`文件：
```
OPTS="-l 1.5 -b 60"
# -l 1.5，将负载阈值设置为1.5
# -b 60 设置两次批处理任务启动的最小间隔为60秒，防止瞬间压垮系统。可选。
```

修改完后重启atd服务即可。


**at的工作模式**

at在运行的时候会将定义好的工作以文本文件的方式写入 /var/spool/at/ 目录内，该工作便能等待 atd 这个服务的调用，但是出于安全考虑，并不是所有的人都可以使用 at 计划任务！所以系统给我们提供了两个文件 /etc/at.allow 与 /etc/at.deny 来进行 at 的使用限制！ 加上这两个文件后， at 的工作情况其实是这样的：

先找寻 /etc/at.allow 这个文件，写在这个文件中的用户才能使用 at ，没有在这个文件中的用户则不能使用 at (即使没有写在 at.deny 当中)；

如果 /etc/at.allow 不存在，就寻找 /etc/at.deny 这个文件，若写在这个 at.deny 的用户则不能使用 at ，而没有在这个 at.deny 文件中的用户，就可以使用 at ；

如果两个文件都不存在，那么只有 root 可以使用 at 这个命令。

在大多数发行版当中，由于假设系统上的所有用户都是可信任的， 因此系统通常会保留一个空的 /etc/at.deny 文件，允许所有人使用 at 。如果有需要的话可以手动建立at.allow文件。




**2、crontab：周期性计划任务**

crontab常用于处理循环性任务，比如每晚备份。使用crond服务来控制。

2.1、crontab使用控制

用户使用的是 crontab 这个命令来定义周期性的计划任务，但是为了安全性的问题， 与 at 同样的，我们可以限制使用 crontab 的用户账号！使用的限制数据有：

**/etc/cron.allow：**  
将可以使用 crontab 的账号写入其中，若不在这个文件内的用户则不可使用 crontab；

**/etc/cron.deny：**  
将不可以使用 crontab 的账号写入其中，若未记录到这个文件当中的用户，就可以使用 crontab 。

与 at 一样，以优先级来说， /etc/cron.allow 比 /etc/cron.deny 要高， 一般系统默认是提供 /etc/cron.deny ， 你可以将允许使用 crontab 用户写入 /etc/cron.deny 当中，一个账号一行。crontab 建立计划任务会存放在 /var/spool/cron/ 目录中，


crontab格式由五个时间字段 + 命令 组成：
`分钟 时 日 月 周 命令`


crontab语法结构

|字段|取值范围|示例|
|---|---|---|
|**分** (Minute)|0 - 59|`30` (第30分钟)|
|**时** (Hour)|0 - 23|`2` (凌晨2点)|
|**日** (Day)|1 - 31|`15` (每月15号)|
|**月** (Month)|1 - 12|`1` (1月)|
|**周** (Week)|0 - 7|`0` 或 `7` 都代表周日|



crontab符号说明

- `*`：**每**。`* * * * *` 表示每分钟执行。
- `,`：**枚举**。`1,3,5` 表示第1、3、5分钟。
- `-`：**范围**。`1-5` 表示周一到周五。
- `/`：**步长**。`*/10` 表示每隔10分钟。

常用命令：
```
# 编辑当前用户的计划任务，每个任务一行
# 格式： 分 时 日 月 周 命令
crontab -e

# 查看任务列表
crontab -l

# 删除所有任务，删除单个任务使用crontab -e
crontab -r
```

在crontab写命令，最好写绝对路径，避免出现问题。

有的老版本crontab要求文件末尾必须有一个空行，否则最后一项任务可能不执行。


crontab -e针对用户，系统的计划任务通过/etc/crontab文件实现，编辑这个文件即可。
![](/assets/img/Pasted image 20260216221247.png)

与crontab -e内容类似，但是多了几个部分：
```
SHELL=/bin/bash         shell类型
PATH=/sbin:/bin:/usr/sbin:/usr/bin  执行文件搜索位置
MAILTO=root     发生错误时通知邮件发送给谁

*  *  *  *  * user-name  command to be executed
#比crontab -e多了一个执行者的身份，因为并不是所有工作都需要root用户去执行
```


**额外的文件**

crond有三个相关联的地方，他们分别是：

/etc/crontab 系统计划任务的配置文件

/etc/cron.d/ 此目录和下面的几个目录都是系统计划任务存放运行脚本的位置。

/etc/cron.hourly/

/etc/cron.daily/

/etc/cron.weekly/

/etc/cron.monthly/

/var/spool/cron/* 用户定制的计划任务存放位置




**3、systemd timers：现行替代方案**

这是Ubuntu16.04和CentOS7以后推荐的方式，正在逐步取代crontab，它不依赖cron进程，而是通过systemd触发。

本质：由一个.timer文件触发一个同名的.service文件。

虽然比crontab -e麻烦，要写两个文件，但是它能精确到毫秒，且日志直接集成到journalctl，方便排查问题。

核心部分：
- `.service`文件：定义做什么
- `.timer`文件：定义什么时候做

查看当前系统所有活跃的定时器
```
systemctl list-timers
```

定时任务设置

第一步，创建服务文件.service，告诉系统做什么

新建文件/etc/systemd/system/mytask.service
内容：
```
[Unit]
Description=我的定时清理脚本

[Service]
ExecStart=/usr/bin/bash /root/clean.sh

```


第二步，创建定时器文件.timer，告诉系统什么时候做。

新建文件`/etc/systemd/system/mytask.timer`（必须与 service 同名）

```
[Unit]
Description=每 5 分钟跑一次清理任务

[Timer]
# 相对时间：开机后 1 分钟开始跑
OnBootSec=1min
# 绝对时间：每隔 5 分钟跑一次
OnUnitActiveSec=5min
# 类似 Cron 的写法：每天凌晨 2 点
# OnCalendar=*-*-* 02:00:00

[Install]
WantedBy=timers.target

```

第三步，启用和管理，告诉systemd刷新并启动这个“闹钟”：
- 1、重载配置：systemctl daemon-reload
- 2、启动定时器：systemctl enable --now mytask.timer
- 3、查看所有定时器：systemctl list-timers，此命令会显示下次执行时间



两种时间模式（重点）

- **单调定时器 (Monotonic Timers)**：基于一个时间点（如开机、或上次执行后）的偏移量。
    - 参数：`OnBootSec`（开机后）, `OnUnitActiveSec`（上次启动后）。
- **实时定时器 (Realtime Timers)**：基于墙上时钟（类似 Cron）。
    - 参数：`OnCalendar`。
    - 写法示例：`OnCalendar=Mon..Fri 10:00` (周一到周五上午10点)。



如果任务失败，直接查日志：`journalctl -u mytask.service`就能看到报错信息



**4、anacron，补充**

anacron专门处理那些因为关机、断电、或休眠而错过的计划任务。

假设你每天设定凌晨两点做备份，但那时如果电脑关了，早上八点你开机以后，cron不会帮你补上2点的任务。

配置文件/etc/anacrontab

不过基本用不上


