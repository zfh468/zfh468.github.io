---
title: iptables之扩展模块与自定义链
date: 2026-02-17 20:00:00 +0800
categories: [Linux,系统管理]
tags: [iptables]
---
## -m扩展模块

-m代表match（匹配模块）。

基础的iptables只能识别源/目的IP、协议等简单信息。使用内核提供的扩展模块可以让防火墙具备更高级的能力。

```
# multiport模块
# 同时开放 80, 443, 8080 端口
iptables -A INPUT -p tcp -m multiport --dports 80,443,8080 -j ACCEPT


# iprange模块
# 屏蔽从 192.168.1.10 到 192.168.1.50 的所有地址
iptables -A INPUT -m iprange --src-range 192.168.1.10-192.168.1.50 -j DROP



# string模块，匹配字符串，检查数据包里是否包含特定的敏感关键词
# --algo，指定匹配算法。常用bm或kmp。一般bm更快
# --string，指定要匹配的字符串

# 如果 HTTP 请求中包含 "GET /admin"，则直接丢弃（简单防黑）
iptables -A INPUT -p tcp --dport 80 -m string --algo bm --string "GET /admin" -j DROP


# 时间模块time，允许你根据时间来控制规则的生效

常用参数：
--timestart / --timestop：起始/结束时间（格式 HH:MM:SS）。

--weekdays：星期几（Mon, Tue, Wed...）。

--datestart / --datestop：特定日期。

# 在周一到周五的 9:00 到 18:00，禁止访问外部端口（防止上班摸鱼）
iptables -A OUTPUT -p tcp --dport 80 -m time --timestart 09:00 --timestop 18:00 --weekdays Mon,Tue,Wed,Thu,Fri -j REJECT

# connlimit连接数限制模块，可以限制并发连接数，可以防御TCP洪水攻击（cc攻击）
# 限制每个 IP 对 Web 服务(80)的并发连接不超过 2 个
iptables -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above 2 -j REJECT

# 限制每个 /24 网段（254个IP）总共只能发起 20 个连接
iptables -I INPUT -p tcp --dport 80 -m connlimit --connlimit-mask 24 --connlimit-above 20 -j REJECT


# limit速率限制模块，常用于防止ping洪水或日志过载

# 允许前 3 个 ICMP 包快速通过，后续每分钟只允许 10 个包进入
iptables -t filter -I INPUT -p icmp -m limit --limit-burst 3 --limit 10/minute -j ACCEPT
# 其余的 ICMP 包全部拒绝
iptables -t filter -A INPUT -p icmp -j REJECT


# 特定协议匹配（UDP&ICMP）
# 允许 137 到 150 之间的所有 UDP 端口进入
iptables -t filter -I INPUT -p udp -m udp --dport 137:150 -j ACCEPT

# 拒绝外部主动 Ping 本机（禁止请求），但允许本机 Ping 外部并收到回复
iptables -t filter -I INPUT -p icmp -m icmp --icmp-type 8/0 -j REJECT




```


## 自定义链


```
# 1、创建新链
iptables -N WEB_RULES

# 2、重命名链
iptables -E WEB_RULES HTTP_RULES

# 3、在自定义链加规则
iptables -I HTTP_RULES -s 192.168.1.32 -j REJECT

# 4、引用到主链
iptables -I INPUT -p tcp --dport 80 -j HTTP_RULES


# 5、清空链内规则
iptables -F HTTP_RULES

# 6、删除自定义链
iptables -X HTTP_RULES

```

自定义链被引用或有规则都无法直接删除！！！

暴力全清：
```
iptables -F          # 1. 清空所有表（filter等）的所有链规则
iptables -X          # 2. 删除所有非预设的自定义链
```
