---
title: iptables防火墙与规则
date: 2026-02-17 12:00:00 +0800
categories: [Linux,系统管理]
tags: [iptables]
---
防火墙种类：

主机防火墙：只保护本机，作用于操作系统内，比如Linux的netfilter、iptables、nftables、firewalld，Windows的windows defender

网络防火墙：保护整个网络，常部署在网络出口

硬件防火墙：网络防火墙的硬件形态
软件防火墙：网络防火墙的软件形态

=======================
## 1.基本概念了解

**netfilter介绍**

netfilter是Linux内核的防火墙框架，负责拦截数据包、修改数据包、丢弃数据包、NAT等。


**iptables介绍**

iptables是用户操作netfilter的代理工具，通过iptables把规则写入内核的netfilter。


**iptables结构**

## 四表(table)

1. filter（默认），最常用，负责过滤（iptables_filter），支持input forward output链
2. nat，负责网络地址转换（iptables_nat），除了forward都可以
3. mangle，解析报文，修改报文，封装报文(iptables_mangle)，全部都可以
4. raw，关闭nat表的连接追踪(iptable_raw)，prerouting output


表优先级关系：raw>mangle>nat>filter。

## 五链（chain）
- INPUT
- OUTPUT
- FORWARD
- PREROUTING
- POSTROUTING


五链的工作流程（数据包流向）：
1. **数据包进入系统时**
```
网卡
  ↓
PREROUTING
  ↓
路由判断
   ├── 目标是本机 → INPUT → 本地进程
   └── 不是本机 → FORWARD → POSTROUTING → 网卡
```

2. 数据包从本机发出
```
本地进程
  ↓
OUTPUT
  ↓
路由判断
  ↓
POSTROUTING
  ↓
网卡
```


## 2. 语法结构

`iptables [-t 表名] 动作 [链名] [匹配条件] -j [执行动作]`

### 2.1常用动作指令

- `-L`：列出规则 (List)
    
- `-A`：追加规则到末尾 (Append)
    
- `-I`：插入规则到指定位置，默认第一行 (Insert)
    
- `-D`：删除规则 (Delete)
    
- `-F`：清空所有规则 (Flush)
    
- `-P`：设置默认策略 (Policy)
    

### 2.2常见匹配条件

- `-p`：协议 (tcp, udp, icmp, all)
    
- `-s`：源地址 (Source IP/Subnet)
    
- `-d`：目标地址 (Destination IP/Subnet)
    
- `--sport` / `--dport`：源端口 / 目标端口
    
- `-i` / `-o`：入站网卡 / 出站网卡 (eth0, lo)
    

### 2.3执行动作 (Target)

- **ACCEPT**：允许通过。
    
- **DROP**：直接丢弃（对方不知道发生了什么，直到超时）。
    
- **REJECT**：明确拒绝（回送 ICMP 错误信息）。
    
- **SNAT / DNAT**：源/目标地址转换（在 nat 表使用）。
    

---

## 3. 快速上手示例 (Cheat Sheet)

### 基础查看

Bash

```
iptables -nvL FORWARD   # 查看forward链
iptables -nvL --line-numbers  # 数字化、详细查看规则及行号
```

### 示例

Bash

```
# 1. 允许本地回环接口 (非常重要，否则本地服务通信会失败)
iptables -A INPUT -i lo -j ACCEPT

# 2. 允许已经建立的或相关的连接 (防止回复包被拦)
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 3. 开放特定端口
iptables -A INPUT -p tcp --dport 22 -j ACCEPT   # SSH
iptables -A INPUT -p tcp --dport 80 -j ACCEPT   # HTTP
iptables -A INPUT -p tcp --dport 443 -j ACCEPT  # HTTPS

# 4. 屏蔽某个IP
iptables -I INPUT -s 123.123.123.123 -j DROP

# 5. 设置默认拒绝策略 (配置完上面的规则后再执行，防止断连)
iptables -P INPUT DROP
```

---

## 4. 注意事项与持久化

- **即时生效**：命令执行后立刻对系统生效。
    
- **重启失效**：`iptables` 命令不会自动保存。
    
    - **Ubuntu/Debian**: 使用 `iptables-persistent` 工具。
        
    - **CentOS/RHEL**: `service iptables save` 或使用 `iptables-save > /etc/sysconfig/iptables`。
        
- **防止锁死**：配置 `DROP` 默认策略前，务必先开放 SSH (22) 端口。建议在测试时使用计划任务在 5 分钟后自动清除规则：`echo "iptables -F" | at now + 5 min`。
    

---

当你发现网络不通时，第一步总是执行 `iptables -L -n` 查看是否被防火墙拦截。

