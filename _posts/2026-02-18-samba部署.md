samba

smb协议，提供网络上不同计算机文件、打印机共享，可以让windows和Linux通信

samba使用端口：
tcp：139，445
udp：137，138


准备一台Windows，两台Linux


**Linux服务端**

安装samba软件包
```
# samba：提供 smbd/nmbd 服务进程
# samba-client：提供 smbclient 等测试工具
# samba-common：配置文件和通用库

dnf install samba samba-client samba-common -y
```

创建共享目录并设置权限
```
mkdir -p /data
chown -R smbuser1:smbuser1 /data
chmod -R 0775 /data
```

注意！！！要给共享目录所有者设置为smb用户，否则如果属于root用户，smbuser1用户无法写入内容


Linux的访问控制有两层：
1. 系统权限（POSIX权限）
2. Samba权限（用户认证）

如果系统权限不允许，即使samba配置允许也无法写入。



关闭selinux
```
setenforce 0
```


创建samba用户

samba不直接使用Linux用户密码，而是使用自己的数据库

创建系统用户（禁止登录）
```
useradd -s /sbin/nologin smbuser1
```

设置samba用户密码
```
# Samba 使用 tdbsam 或 ldapsam 存储认证信息
# 默认数据库：/var/lib/samba/private/passdb.tdb
# 必须先有 Linux 用户，再加入 Samba 用户
# 这是为了与系统 UID/GID 对应

smbpasswd -a smbuser1
```

配置samba主配置文件

配置文件位置`/etc/samba/smb.conf`

修改内容
```
[global]
    workgroup = WORKGROUP
    security = user   
    map to guest = Bad User
    passdb backend = tdbsam   

[data]
    path = /data
    browseable = yes
    writable = yes
    valid users = smbuser1    #限制访问用户
    create mask = 0664        # 控制新建文件权限
    directory mask = 0775    
```


启动服务
```
systemctl enable --now smb
```

服务状态检查
```
systemctl status smb
```

samba服务包含smbd（文件共享）和nmbd（netbios名称解析）。


防火墙放行samba
```
firewall-cmd --permanent --add-service=samba
firewall-cmd --reload
```




**测试访问**

windows客户端测试

资源管理器输入
```
\\192.168.10.100
```

输入用户名smbuser1和密码



linux客户端测试

安装smb客户端
```
dnf install -y samba-client
```

```
smbclient -L //服务端ip -U smbuser1
```




====================================================


补充：


samba常用命令

```
# 添加用户
smbpasswd -a 用户名

# 删除samba用户
smbpasswd -x 用户名

# 禁用/启用用户
smbpasswd -d 用户名   # 禁用
smbpasswd -e 用户名   # 启用

# 查看samba用户
pdbedit -L

# 检查配置文件语法
testparm

# 查看当前连接会话
smbstatus
```


客户端命令（linux）
```
# 1、列出共享目录
smbclient -L //服务器IP -U 用户名

# 2、连接共享目录
smbclient //服务器IP/共享名 -U 用户名
# 进入后类似ftp命令：ls、get、put


# 除了smbclient命令也可以挂载到本地目录操作
# 3、挂载到本地目录
# CIFS是smb实现协议
mkdir -p /mnt/mydata
mount -t cifs //服务端ip/data /mnt/mydata \
-o username=smbuser1,password=123456
```

防火墙命令
```
firewall-cmd --permanent --add-service=samba
firewall-cmd --reload
```

查看防火墙
```
firewall-cmd --list-all
```

