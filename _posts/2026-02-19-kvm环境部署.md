
**一、准备**

AlmaLinux-9.7-x86_64-minimal.iso

vmware


**二、安装工程**

vmware中选择最小化安装，其他随意，完成安装后重启系统。



**三、系统环境配置**

关闭防火墙
```
systemctl disable firewalld --now
```

关闭selinux
```
sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config
reboot
```

vmware虚拟机设置>处理器>勾选VT-x (Intel) 或 AMD-V支持。否则alma linux虚拟机会认为自己的cpu不能跑kvm环境。

在同样位置，勾选虚拟化IOMMU。

真实应用场景下，直接在物理服务器上的主板BIOS/UEFI开启虚拟化，把开关设置为`Enabled`。

如果使用ECS，普通的云服务器进不去BIOS，没法勾选虚拟化，不支持装kvm。想要在云服务器里跑虚拟机，要购买更昂贵的**裸金属服务器(Cloud Bare Metal，CBM)**。




**四、kvm虚拟化环境部署**

4.1、安装kvm相关组件
```
dnf groupinstall -y "Virtualization Host"
```


4.2、启动libvirtd
```
systemctl enable --now libvirtd
```


4.3、验证kvm环境是否部署成功
```
lsmod | grep kvm
virsh list --all

# 输出的数字代表支持硬件虚拟化的核心数
# 数字=0说明虚拟化没开或者不支持
grep -c -E 'vmx|svm' /proc/cpuinfo

# 验证虚拟化环境
virt-host-validate
```


问题1：  `QEMU: Checking if IOMMU is enabled by kernel (系统不支持IOMMU)`

解决方法：
1. 修改 /etc/default/grub。
2. 在 GRUB_CMDLINE_LINUX 行末尾添加 intel_iommu=on（AMD 则是 amd_iommu=on）。
3. 执行 `grub2-mkconfig 或者grubby --update-kernel=ALL --args="intel_iommu=on"`并**重启**。

![[Pasted image 20260220043444.png]]

问题2：  `QEMU: Checking for secure guest support `

这是CPU的一个高级安全特性，通过硬件加密虚拟机内存，防止宿主机偷看虚拟机数据。

除了安全要求特别高的业务，一般不用开。

解决方法：

进 BIOS 寻找以下关键词并设置为 `Enabled`：
1. AMD： Secure Encrypted Virtualization (SEV)
2. Intel： Total Memory Encryption (TME) 或 Trust Domain Extensions (TDX)


**五、环境清理**

清理日志
```
# 清空日志内容，但保留文件
truncate -s 0 /var/log/*log
```

清理缓存
```
dnf clean all
```

删除机器标识
```
rm -f /etc/machine-id
touch /etc/machine-id
```



完成以上步骤，就制作好了一个部署好kvm虚拟化环境的alma linux虚拟机，它可以作为模板机直接用于实验或批量克隆。


