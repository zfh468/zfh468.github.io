

准备三台Alma Linux虚拟机
一台作为lvs路由，两台rs

**网络结构**

lvs负载机 ens 160192.168.88.140(nat)，ens224 vip 192.168.248.128(host-only)
rs1 ens160 192.168.248.129
rs2 ens160 192.168.248.130

外网192.168.88.0/24
内网 192.168.248.0/24

vip作为对外服务ip


**两台rs服务器配置**

安装web服务
```
dnf install -y httpd
systemctl enable --now httpd
```

测试页面
rs1
```
echo "RS1" > /var/www/html/index.html
```

rs2
```
echo "RS2" > /var/www/html/index.html
```


设置默认网关，指向lvs内网ip，保证nat模式下所有回包经过lvs
```
ip route replace default via 192.168.248.128
```

关闭防火墙
```
systemctl stop firewalld
```

**lvs配置**

安装ipvsadm
```
dnf install -y ipvsadm
```

开启ip转发，nat必须，Linux默认不转发数据包
```
echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
sysctl -p
```

添加VIP，绑定外网网卡（nmcli命令更好）
```
ip addr add 192.168.88.100/24 dev ens160
```
验证：
```
ip addr | grep 192.168.88.100
```

nat转换配置
```
# 修改源地址，客户端看到的源ip是vip，而不是rs的真实ip
iptables -t nat -A POSTROUTING -s 192.168.248.0/24 -j MASQUERADE
```

如果需要清空旧规则
```
ipvsadm -C
```

创建虚拟服务
```
# -A 添加虚拟服务
# -t tcp服务
# -s rr 轮询算法
ipvsadm -A -t 192.168.88.100:80 -s rr
```


添加rs
```
# -a 添加rs服务器
# -m nat模式
ipvsadm -a -t 192.168.88.100:80 -r 192.168.248.129:80 -m
ipvsadm -a -t 192.168.88.100:80 -r 192.168.248.130:80 -m
```


关闭防火墙

**验证步骤**

1、查看lvs状态
```
ipvsadm -Ln
```
![[Pasted image 20260224064945.png]]

2、客户端测试
使用其他Linux虚拟机192.168.88.141测试
```
curl 192.168.88.100
```
![[Pasted image 20260224064955.png]]
3、抓包分析或排错
```
tcpdump -i ens224
tcpdump -i ens160 host 192.168.88.141
```

lvs nat模式的性能比较一般，且需要多个网卡


