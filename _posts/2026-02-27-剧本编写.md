---
title: ansible剧本编写
date: 2026-02-27 11:00:00 +0800
categories: [ansible]
tags: [playbook]
---
**介绍**

playbook（剧本）使用yaml格式编写，它是一个**自动化任务脚本**，负责定义在哪些机器干活以及具体干什么。


**案例**:在三台alma linux虚拟机部署lnmp


编写playbook
```
vi lnmp.yml
```

内容

```
---
- name: 自动化部署 LNMP 环境 (针对 AlmaLinux 10)
  hosts: all
  become: yes

  tasks:
    # 1. 安装 Nginx
    - name: 安装 Nginx
      package:               # 自动判断使用dnf还是apt；    
        name: nginx
        state: present

    # 2. 安装 MariaDB
    - name: 安装 MariaDB 数据库
      package:
        name: mariadb-server
        state: present

    # 3. 安装 PHP
    - name: 安装 PHP 核心及相关组件
      package:
        name: 
          - php
          - php-fpm
          - php-mysqlnd      # 注意：RHEL系通常叫 php-mysqlnd
        state: present

    # 4. 启动服务
    - name: 启动 Nginx 并设置自启
      service:
        name: nginx
        state: started
        enabled: yes

    - name: 启动 MariaDB 并设置自启
      service:
        name: mariadb
        state: started
        enabled: yes
```



批量部署lnmp
```
# 使用指定的主机清单hosts，执行名为lnmp的playbook自动化部署脚本
ansible-playbook -i hosts lnmp.yml
```

![](/assets/img/Pasted image 20260227180442.png)


lnmp验证
```
# 检查 Nginx 是否在线
ansible all -i hosts -m shell -a "systemctl status nginx | grep Active"

# 检查 PHP-FPM 是否在线
ansible all -i hosts -m shell -a "systemctl status php-fpm | grep Active"
```


![](/assets/img/Pasted image 20260227180808.png)

如图所示，三台alma linux部署lnmp成功



alma linux默认开启防火墙，不放行80端口浏览器无法访问

写一个playbook批量放行

```
- name: 开启 HTTP 防火墙端口
  hosts: all
  become: yes
  tasks:
    - name: 允许 80/tcp 流量
      firewalld:
        service: http
        permanent: yes
        state: enabled
        immediate: yes

```



然后执行
```
ansible-playbook -i hosts firewalld.yml
```
![](/assets/img/Pasted image 20260227181218.png)



**实战验证**


编写测试页面，确认nginx是否能把php请求交给php-fpm处理


1、分发测试文件

在ansible管理机(ubuntu)上新建一个info.php
```
echo "<?php phpinfo(); ?>" > info.php
```


2、分发测试文件到web目录
```
ansible all -i hosts -m copy -a "src=info.php dest=/usr/share/nginx/html/info.php"
```




3、打开浏览器分别访问

这里只给一张截图，没必要都截出来，意思到了就行

![](/assets/img/Pasted image 20260227181902.png)


